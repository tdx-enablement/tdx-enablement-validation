# Ubuntu 22.04 TDX Guest Image Tool

## 1. Overview

This project is used to create a customized Ubuntu TDX guest image from an official Ubuntu cloud image:
- Include TDX enabled packages like kernel, grub, shim etc.
- Include TDX guest tools like `pytdxmeasure`, `amber-cli` etc.
- Include full measured boot
- Include secure boot (TBD)
- Include full DCAP packages from https://download.01.org/intel-sgx/latest/dcap-latest/linux/ (TBD)

It allows the customizations via the `cloud-init` script, please see [meta-data.template](cloud-init-data/meta-data.template) and [user-data.template](cloud-init-data/user-data.template).

![](/doc/create-ubunt-guest-image.png)

## 2. Prerequisites

- It can run on any Linux machine without relying on TDX.
- Build all packages via the script [`build-repo.sh`](../build-repo.sh), by default the built packages (`*.deb`/`*.rpm`) will be put into the directories `guest_repo` and `host_repo` under the same directory of the file `build-repo.sh`.
- Install the following apps or tools:
  - Ubuntu:
  ```
  sudo apt install qemu-utils libguestfs-tools virtinst genisoimage
  ```
  - RHEL/CentOS Stream:
  ```
  sudo dnf install libguestfs-tools-c qemu-img virt-install genisoimage
  ```

## 3. Usage

  The command usage is :

  ```
  Usage: create-ubuntu-image.sh [OPTION]...
    -h                        Show this help
    -c                        Create customize image (not from Ubuntu official cloud image)
    -f                        Force to recreate the output image
    -n                        Guest host name, default is "tdx-guest"
    -u                        Guest user name, default is "tdx"
    -p                        Guest password, default is "123456"
    -s                        Specify the size of guest image
    -o <output file>          Specify the output file, default is tdx-guest-ubuntu-22.04.qcow2.
                              Please make sure the suffix is qcow2. Due to permission consideration,
                              the output file will be put into /tmp/<output file>.
    -r <guest repo>           Specify the directory including guest packages, generated by build-repo.sh
  ```

  NOTE:
  - Please refer https://cloudinit.readthedocs.io/en/latest/reference/examples.html for cloud-init configuration, then update [user-data.template](./cloud-init-data/user-data.template)
  - Please refer https://www.libguestfs.org/virt-customize.1.html for more customizations via `virt-customize`

## 4. Examples

1. Specify the size of disk image

  ```
  sudo ./create-ubuntu-image.sh -r ../guest_repo/ -f -s 50
  ```

  NOTE:
  - `sudo` is not required if current user is in libvirt (RHEL style) or libvirt-qemu (Ubuntu style)
  - By default, the output file will be put at /tmp/tdx-guest-ubuntu-22.04.qcow2

2. Specify the output file name

  ```
  sudo ./create-ubuntu-image.sh -r ../guest_repo/ -f -o mytest.qcow2
  ```
  NOTE:
  - Please make sure the output file name is ends with `*.qcow2`


3. Specify the `user name`, `password` and `hostname`

  ```
  sudo ./create-ubuntu-image.sh -r ../guest_repo/ -f -o mytest.qcow2 -u tdx -p changeme -n tdx-guest
  ```
