## Setup TDX Guest Image

### Create EFI Cloud Image

The cloud image could be MBR based legacy image like [CentOS Cloud Image](https://cloud.centos.org/centos/8-stream/),
or EFI GPT based cloud image like [Ubuntu Cloud Image](https://cloud-images.ubuntu.com/).
For direct boot, any type of cloud image

| Guest Image Type | Example | Description |
| -- | -- | -- |
| MBR based Legacy | [CentOS Cloud Image](https://cloud.centos.org/centos/8-stream/) | Support direct boot for TDX guest |
| GPT based EFI | [Ubuntu Cloud Image](https://cloud-images.ubuntu.com/) | Support both direct and EFI grub boot for TDX guest |

This chapter use `CentOS Stream` as example base distro. The default cloud image
for CentOS Stream does not support EFI schema, so need create customized EFI
based CentOS image via [TDX Guest Image Tool](https://github.com/intel/tdx-tools/tree/main/build/centos-stream-8/guest-image).

### Prerequisite

- Install required packages:

  ```
  sudo dnf install -y virt-install libguestfs-tools-c
  ```

- TDX guest RPM repository was already generated by [build-repo.sh](https://github.com/intel/tdx-tools/tree/main/build/centos-stream-8/build-repo.sh)

- Make sure libvirtd service and the default virbr0 interface works normal via

  ```
  systemctl status libvirtd
  ifconfig virbr0
  ```

### Install Guest Image With ISO Installer

Generate guest image td-guest-c8s.qcow2:

```
cd tdx-tools/build/centos-stream-8/guest-image/
./create-efi-img.sh
```

_NOTE:_

- The script will download CentOS-Stream-8-x86_64-latest-dvd1.iso (~10G) if it
does not exist.
- Then run virt-install to install guest image using kickstart scripts.

### Install TDX Guest Stack into the Guest Image

Install tdx-guest-grub2, tdx-guest-shim and tdx-guest-kernel:

```
./tdx-guest-stack.sh
```

_NOTE:_

- It will copy TDX guest repo to td-guest-c8s.qcow2 and install the guest
packages
- Use the existing host environment in the guest. Such as /etc/environment,
/etc/chrony.conf
- This script can be used as an example of how to install necessary guest
components if a custom image is wanted.
